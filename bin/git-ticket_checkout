#! /usr/bin/env rvm 2.1.1@default do ruby

class TicketCheckout
  def call
    ['/Sites/apps/*', '/Sites/gems/*'].map{|d| Dir.home + d }.each do |superdir|
      Dir[superdir].each do |dir|
        Dir.chdir(dir) do
          switch_branch
        end
      end
    end
    puts `git current_branches`
  end

  def switch_branch
    if branch_exists?
      commit_changes
      checkout_branch
      reset_generated_commits
    end
  end

  def branch_exists?
    get_branch ? true : false
  end

  def get_branch
    get_branch_uncached
  end

  def get_branch_uncached
    branch_match = `git branch -r`.match(/(FY-)?#{ARGV[0]}(\w+)?/)
    branch_match ? branch_match[0].to_s : false
  end

  def commit_changes
    `git g`
    `git add -A`
    `git commit -m "generated by script, run 'reset HEAD~1'"`
  end

  def checkout_branch
    `git checkout #{get_branch}`
  end

  def reset_generated_commits
    if last_commit_was_generated?
      `git reset HEAD~1`
    end
  end

  def last_commit_was_generated?
    commit = `git log -1 --oneline`
    commit.match(/generated.by.script/) ? true : false
  end
end

TicketCheckout.new.call
